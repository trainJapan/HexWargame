<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wargame Editor v2.1 - Visual Fixes</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-panel: #222;
            --accent: #00cc88;
            --uk-blue: #4488ff;
            --ger-red: #ff4444;
            --text-main: #e0e0e0;
            --border: #444;
        }

        body { 
            margin: 0; padding: 0; 
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg-dark); color: var(--text-main);
            height: 100vh; display: grid;
            grid-template-columns: 300px 1fr 340px;
            overflow: hidden;
        }

        /* TABS & PANELS */
        .tab-bar { display: flex; border-bottom: 1px solid var(--border); background: #2a2a2a; }
        .tab { flex: 1; padding: 10px; cursor: pointer; text-align: center; font-size: 11px; background: #333; border-right: 1px solid var(--border); }
        .tab.active { background: var(--bg-panel); color: var(--accent); border-bottom: 2px solid var(--accent); font-weight: bold; }
        .tab-content { display: none; padding: 15px; overflow-y: auto; height: calc(100vh - 120px); }
        .tab-content.active { display: block; }

        .panel { background: var(--bg-panel); display: flex; flex-direction: column; overflow: hidden; z-index: 10; border-right: 1px solid var(--border); border-left: 1px solid var(--border); }
        
        .section-header { color: var(--accent); font-size: 13px; font-weight: bold; text-transform: uppercase; margin: 15px 0 5px 0; border-bottom: 1px solid #444; padding-bottom: 2px; }
        .label { font-size: 11px; color: #888; margin-bottom: 3px; display:block; }
        
        input, textarea, select {
            background: #333; border: 1px solid #555; color: white;
            padding: 6px; width: 100%; box-sizing: border-box;
            border-radius: 4px; font-family: inherit; margin-bottom: 8px; font-size: 12px;
        }

        /* BUTTONS */
        .btn { background: #444; color: white; border: 1px solid #555; padding: 8px; cursor: pointer; border-radius: 4px; text-align: center; font-weight: bold; width: 100%; font-size: 12px; }
        .btn:hover { background: #555; }
        .btn-primary { background: var(--accent); color: #000; border: none; }
        .btn.active { border-color: var(--accent); background: #224422; color: var(--accent); }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }

        /* RICH LIST ITEMS (Inspector / Tray / Reinf) */
        .rich-list { border: 1px solid #444; background: #111; height: 140px; overflow-y: auto; margin-bottom: 10px; padding: 5px; }
        
        .stack-item, .list-item { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #333; margin-bottom: 4px; padding: 4px; border-radius: 3px; border: 1px solid transparent;
        }
        .stack-item:hover, .list-item:hover { border-color: #666; }
        
        .item-icon { width: 32px; height: 32px; margin-right: 8px; object-fit: contain; }
        .item-info { flex-grow: 1; }
        .item-title { font-weight: bold; font-size: 11px; color: #fff; }
        .item-meta { font-size: 10px; color: #aaa; }
        
        .btn-mini { padding: 2px 6px; font-size: 10px; cursor:pointer; background:#555; border:none; color:white; border-radius:3px; }
        .btn-danger-mini { background: #cc4444; }

        /* TERRAIN PALETTE */
        .palette-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
        .terrain-item { cursor: pointer; border: 2px solid transparent; height: 40px; }
        .terrain-item img { width: 100%; height: 100%; object-fit: cover; }
        .terrain-item.selected { border-color: var(--accent); transform: scale(0.95); }

        #game-container { position: relative; background: #111; overflow: hidden; }
        #status-bar { position: absolute; top:10px; left:50%; transform:translateX(-50%); background:var(--accent); color:#000; padding:4px 12px; font-weight:bold; border-radius:4px; font-size:12px; display:none; pointer-events:none; z-index:1000; }
        
        #json-modal { position: absolute; top:50px; left:50%; transform:translateX(-50%); width: 400px; background: #222; border: 2px solid var(--accent); padding: 20px; z-index: 2000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
    </style>
</head>
<body>

<div class="panel" style="border-left:none;">
    <div style="padding:10px; background:#222; border-bottom:1px solid #444; font-weight:bold; color:var(--accent);">MAP EDITOR</div>
    <div style="padding:10px; overflow-y:auto; flex-grow:1;">
        
        <div class="label">MAP DIMENSIONS</div>
        <div class="grid-2">
            <input type="number" id="cols" value="15" min="5">
            <input type="number" id="rows" value="12" min="5">
        </div>
        <button class="btn" onclick="regenerateMap()">Resize Map</button>

        <div class="section-header">TERRAIN PALETTE</div>
        <div class="palette-grid" id="terrain-palette"></div>

        <div class="section-header">TOOLS & ZONES</div>
        <button id="btn-road" class="btn" style="margin-bottom:5px; border-left:3px solid #ccaa00" onclick="setMode('road')">DRAW ROADS</button>
        <button id="btn-vl" class="btn" style="margin-bottom:5px; border-left:3px solid #ffcc00; color:#ffcc00" onclick="setMode('vl')">VICTORY LOCATION (★)</button>
        <div class="grid-2">
            <button id="btn-zone-uk" class="btn" style="border-left:3px solid var(--uk-blue); color:var(--uk-blue)" onclick="setMode('zone-uk')">UK SETUP</button>
            <button id="btn-zone-ger" class="btn" style="border-left:3px solid var(--ger-red); color:var(--ger-red)" onclick="setMode('zone-ger')">GER SETUP</button>
        </div>

        <div class="section-header">PLACE UNIT (ON MAP)</div>
        <div class="grid-2">
            <div><label class="label">SIDE</label><select id="placer-side"><option value="blue">UK</option><option value="red">GERMAN</option></select></div>
            <div><label class="label">TYPE</label><select id="placer-type"><option value="infantry">Infantry</option><option value="vehicle">Vehicle</option></select></div>
        </div>
        <label class="label">INITIAL STATUS</label>
        <select id="placer-status">
            <option value="clear">Ready</option>
            <option value="shaken">Shaken</option>
            <option value="damaged">Damaged (Veh)</option>
            <option value="immobilized">Immobilized (Veh)</option>
        </select>
        <button id="btn-unit" class="btn btn-primary" onclick="setMode('unit')">PLACE UNIT</button>

        <div class="section-header">HEX INSPECTOR</div>
        <div id="hex-inspector-info" style="font-size:11px; color:#aaa; margin-bottom:5px;">Select a hex to see contents.</div>
        <div id="hex-inspector-panel"></div>

    </div>
</div>

<div id="game-container">
    <div id="status-bar">MODE: PAINT</div>
    <div id="json-modal">
        <h3 style="margin-top:0; color:var(--accent)">Import / Export</h3>
        <textarea id="json-input" rows="10"></textarea>
        <div class="grid-2">
            <button class="btn btn-primary" onclick="loadJSON()">Load</button>
            <button class="btn" onclick="toggleModal()">Close</button>
        </div>
    </div>
</div>

<div class="panel" style="border-right:none;">
    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('general')">GEN</div>
        <div class="tab" onclick="switchTab('tray')">TRAY</div>
        <div class="tab" onclick="switchTab('reinf')">REINF</div>
        <div class="tab" onclick="switchTab('rules')">RULES</div>
    </div>

    <div id="tab-general" class="tab-content active">
        <div class="section-header">SCENARIO INFO</div>
        <label class="label">TITLE</label><input type="text" id="scen-title" value="New Scenario">
        <label class="label">AUTHOR</label><input type="text" id="scen-author" value="Designer">
        <label class="label">BRIEFING</label><textarea id="scen-desc" rows="6">Briefing...</textarea>
        
        <div class="section-header">ENVIRONMENT</div>
        <div class="grid-2">
            <div><label class="label">VISIBILITY</label><select id="env-vis"><option value="normal">Normal</option><option value="bad">Bad</option></select></div>
            <div><label class="label">TIME</label><select id="env-time"><option value="day">Day</option><option value="night">Night</option></select></div>
        </div>
        
        <div class="section-header">COMMAND POINTS</div>
        <div class="grid-2">
            <div><label class="label">UK (Blue)</label><input type="number" id="cp-blue" value="5"></div>
            <div><label class="label">GER (Red)</label><input type="number" id="cp-red" value="5"></div>
        </div>
        <label class="label">MAX TURNS</label><input type="number" id="scen-turns" value="10">
    </div>

    <div id="tab-tray" class="tab-content">
        <div class="section-header">COUNTER TRAY</div>
        <div class="grid-2">
            <select id="tray-side"><option value="blue">UK</option><option value="red">GERMAN</option></select>
            <select id="tray-type"><option value="infantry">Infantry</option><option value="vehicle">Vehicle</option></select>
        </div>
        <button class="btn btn-primary" onclick="addTrayUnit()">+ Add to Tray</button>
        
        <div class="label" style="margin-top:10px">UK TRAY</div>
        <div id="list-tray-blue" class="rich-list"></div>
        <div class="label">GER TRAY</div>
        <div id="list-tray-red" class="rich-list"></div>
    </div>

    <div id="tab-reinf" class="tab-content">
        <div class="section-header">REINFORCEMENTS</div>
        <div class="grid-2">
            <select id="reinf-side"><option value="blue">UK</option><option value="red">GER</option></select>
            <select id="reinf-type"><option value="infantry">Infantry</option><option value="vehicle">Vehicle</option></select>
        </div>
        <div class="grid-3">
            <div><label class="label">TURN</label><input type="number" id="reinf-turn" value="3"></div>
            <div><label class="label">%</label><input type="number" id="reinf-chance" value="100"></div>
            <div><label class="label">LOC</label>
                <select id="reinf-loc-type">
                    <option value="edge">Edge</option>
                    <option value="setup">Zone</option>
                    <option value="hex">Hex</option>
                </select>
            </div>
        </div>
        <label class="label">LOC VALUE (N/S/W/E OR '8,6')</label>
        <input type="text" id="reinf-val" value="W">
        <button class="btn btn-primary" onclick="addReinf()">+ Add Reinf</button>
        <div id="list-reinf" class="rich-list"></div>

        <div class="section-header">OFF-BOARD ASSETS</div>
        <select id="off-type"><option value="artillery">Artillery Strike</option><option value="air">Air Strike</option></select>
        <div class="grid-3">
            <select id="off-side"><option value="blue">UK</option><option value="red">GER</option></select>
            <input type="number" id="off-turn" value="1">
            <input type="number" id="off-chance" value="50">
        </div>
        <button class="btn btn-primary" onclick="addOffBoard()">+ Add Asset</button>
        <div id="list-offboard" class="rich-list" style="height:60px;"></div>
    </div>

    <div id="tab-rules" class="tab-content">
        <div class="section-header">VICTORY LOCATIONS</div>
        <div id="list-vl" class="rich-list" style="height:80px;"></div>

        <div class="section-header">SUDDEN DEATH</div>
        <div class="grid-2">
            <div><label class="label">UK THRESH %</label><input type="number" id="thresh-blue" value="0"></div>
            <div><label class="label">GER THRESH %</label><input type="number" id="thresh-red" value="0"></div>
        </div>
        
        <div style="margin-top:30px;">
            <button class="btn" onclick="toggleModal()">Import JSON</button>
            <button class="btn btn-primary" style="margin-top:5px; padding:15px;" onclick="exportScenario()">EXPORT SCENARIO</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const ASSETS_URL = 'https://raw.githubusercontent.com/trainJapan/HexWargame/main/artwork/';
const TERRAIN_TYPES = {
    'clear': { color: 0x98FB98 }, 'fields': { color: 0xCCAA00 }, 'beach': { color: 0xFFFF99 },
    'broken': { color: 0x8B4513 }, 'orchard': { color: 0x00FF00 }, 'rural': { color: 0xFF9999 },
    'forest': { color: 0x228B22 }, 'urban': { color: 0xCC0000 }, 'industrial': { color: 0x808080 },
    'water': { color: 0x4169E1 }, 'hill': { color: 0x8B7355 }
};
const HEX_RADIUS = 40; // Exact match to Game v0.6

// --- DATA MODEL ---
let mapData = { cols: 15, rows: 12 };
let hexMap = {}; 
let units = []; // Locked units
let trayUnits = [];
let reinforcements = [];
let offBoardAssets = [];
let victoryLocations = [];
let roadSegments = [];
let lastRoadNode = null;
let idCounter = 1;

// Editor State
let currentMode = 'paint'; 
let activeTerrain = 'clear';
let selectedHex = null;

// Phaser
let scene, hexGroup, overlayGroup, zoneGraphics;

const config = {
    type: Phaser.AUTO, parent: 'game-container',
    width: window.innerWidth - 640, height: window.innerHeight,
    backgroundColor: '#111',
    scene: { preload: preload, create: create, update: update }
};
const game = new Phaser.Game(config);

function preload() {
    for (const k in TERRAIN_TYPES) for(let i=1; i<=3; i++) this.load.image(`${k}${i}`, `${ASSETS_URL}map/${k}${i}.png`);
    ['UK_Inf','UK_Veh','GER_Inf','GER_Veh'].forEach(k => this.load.image(k, `${ASSETS_URL}counters/${k}.png`));
}

function create() {
    scene = this;
    hexGroup = this.add.group();
    overlayGroup = this.add.group();
    zoneGraphics = this.add.graphics().setDepth(500); 
    
    this.cameras.main.setBounds(-1000, -1000, 5000, 5000);
    this.input.mouse.disableContextMenu();
    this.input.on('wheel', (p, g, x, y) => scene.cameras.main.setZoom(Phaser.Math.Clamp(scene.cameras.main.zoom - y*0.001, 0.3, 2)));
    this.input.on('pointerdown', handleMapClick);

    initUI();
    regenerateMap();
}

function update() {
    if (this.input.activePointer.rightButtonDown()) {
        const p = this.input.activePointer;
        this.cameras.main.scrollX -= (p.x - p.prevPosition.x) / this.cameras.main.zoom;
        this.cameras.main.scrollY -= (p.y - p.prevPosition.y) / this.cameras.main.zoom;
    }
}

// --- LOGIC ---

function handleMapClick(pointer) {
    if(!pointer.leftButtonDown()) return;
    const hex = getHexAtPoint(pointer.worldX, pointer.worldY);
    if (!hex) { selectedHex = null; updateInspector(); return; }

    selectedHex = hex;
    updateInspector();

    if (currentMode === 'paint') {
        hex.terrain = activeTerrain; hex.variant = Phaser.Math.Between(1,3); drawMap(); 
    }
    else if (currentMode === 'road') {
        if (lastRoadNode && (lastRoadNode.q !== hex.q || lastRoadNode.r !== hex.r)) {
            roadSegments.push({ from: {q:lastRoadNode.q, r:lastRoadNode.r}, to: {q:hex.q, r:hex.r} });
            drawMap();
        }
        lastRoadNode = hex;
    }
    else if (currentMode === 'unit') {
        const side = document.getElementById('placer-side').value;
        const type = document.getElementById('placer-type').value;
        const status = document.getElementById('placer-status').value;
        units.push({
            id: idCounter++, side, unitType: type, q: hex.q, r: hex.r,
            facing: 0, status, hp: 5, mp: 6, maxMp: 6, fp: 3, range: 6
        });
        updateInspector(); drawMap();
    }
    else if (currentMode === 'vl') {
        const existing = victoryLocations.findIndex(v => v.q === hex.q && v.r === hex.r);
        if (existing >= 0) victoryLocations.splice(existing, 1);
        else {
            const points = prompt("Victory Points (100, 200, 500):", "100");
            if(points) victoryLocations.push({ q: hex.q, r: hex.r, points: parseInt(points) });
        }
        updateLists(); drawMap();
    }
    else if (currentMode === 'zone-uk') { hex.setupZone = (hex.setupZone==='blue') ? null : 'blue'; drawMap(); }
    else if (currentMode === 'zone-ger') { hex.setupZone = (hex.setupZone==='red') ? null : 'red'; drawMap(); }
}

function updateInspector() {
    const p = document.getElementById('hex-inspector-panel');
    const info = document.getElementById('hex-inspector-info');
    if (!selectedHex) { p.innerHTML = ''; info.innerText = "Select a hex to see contents."; return; }

    info.innerText = `Selected Hex: (${selectedHex.q}, ${selectedHex.r})`;
    
    const hexUnits = units.filter(u => u.q === selectedHex.q && u.r === selectedHex.r);
    if (hexUnits.length === 0) {
        p.innerHTML = '<div style="font-size:11px; color:#666; font-style:italic">No locked units.</div>';
        return;
    }

    p.innerHTML = hexUnits.map(u => {
        let name = (u.side==='blue' ? 'UK ' : 'GER ') + u.unitType.charAt(0).toUpperCase() + u.unitType.slice(1);
        let imgKey = (u.side==='blue' ? 'UK_' : 'GER_') + (u.unitType==='infantry'?'Inf':'Veh');
        let facingDir = ["N","NE","SE","S","SW","NW"][u.facing];
        return `
        <div class="stack-item">
            <div style="display:flex; align-items:center;">
                <img src="${ASSETS_URL}counters/${imgKey}.png">
                <div>
                    <div class="item-title">${name}</div>
                    <div class="item-meta">Face: ${facingDir} | ${u.status}</div>
                </div>
            </div>
            <div class="stack-controls">
                <button class="btn-mini" onclick="rotateUnit(${u.id})">↻</button>
                <button class="btn-mini btn-danger-mini" onclick="deleteUnit(${u.id})">X</button>
            </div>
        </div>`;
    }).join('');
}

window.rotateUnit = (id) => { const u = units.find(x=>x.id===id); if(u){ u.facing=(u.facing+1)%6; updateInspector(); drawMap(); } };
window.deleteUnit = (id) => { units = units.filter(x=>x.id!==id); updateInspector(); drawMap(); };

// --- RENDERING (EXACT GAME MATH) ---

function getHexPoly(q, r) {
    const x = q * HEX_RADIUS * 1.5;
    const y = r * HEX_RADIUS * Math.sqrt(3) + (q % 2 === 1 ? HEX_RADIUS * Math.sqrt(3) / 2 : 0);
    const points = [];
    for (let i = 0; i < 6; i++) {
        const angle = (Math.PI / 3) * i;
        points.push({ x: x + HEX_RADIUS * Math.cos(angle), y: y + HEX_RADIUS * Math.sin(angle) });
    }
    return { x, y, points };
}

function drawMap() {
    overlayGroup.clear(); hexGroup.clear(); zoneGraphics.clear();

    // 1. Hexes & Zones
    for (let q = 0; q < mapData.cols; q++) {
        for (let r = 0; r < mapData.rows; r++) {
            const hex = hexMap[q][r];
            const pos = getHexPoly(hex.q, hex.r);
            
            // Texture
            const key = `${hex.terrain}${hex.variant||1}`;
            if(scene.textures.exists(key)) {
                // FIXED: Visual size now matches Game logic exactly
                const img = scene.add.image(pos.x, pos.y, key);
                img.setDisplaySize(HEX_RADIUS * 2, HEX_RADIUS * 2);
                
                // Masking to make it perfectly hexagonal (fixes overlaps)
                const shape = scene.make.graphics().fillStyle(0xffffff).beginPath();
                pos.points.forEach((p, i) => i===0 ? shape.moveTo(p.x, p.y) : shape.lineTo(p.x, p.y));
                shape.closePath().fillPath();
                img.setMask(shape.createGeometryMask());
                hexGroup.add(img);
            }
            // Grid
            const g = scene.add.graphics().lineStyle(1, 0x333333).strokePoints(pos.points, true, true);
            hexGroup.add(g);

            // Setup Zones Overlay
            if (hex.setupZone === 'blue') {
                zoneGraphics.fillStyle(0x4488ff, 0.3); zoneGraphics.fillPoints(pos.points, true);
            } else if (hex.setupZone === 'red') {
                zoneGraphics.fillStyle(0xff4444, 0.3); zoneGraphics.fillPoints(pos.points, true);
            }
        }
    }

    // 2. Roads
    const rg = scene.add.graphics();
    roadSegments.forEach(seg => {
        const p1 = getHexPoly(seg.from.q, seg.from.r);
        const p2 = getHexPoly(seg.to.q, seg.to.r);
        rg.lineStyle(8, 0x000000).lineBetween(p1.x, p1.y, p2.x, p2.y);
        rg.lineStyle(5, 0xaaaaaa).lineBetween(p1.x, p1.y, p2.x, p2.y);
    });
    overlayGroup.add(rg);

    // 3. Units
    units.forEach(u => {
        const p = getHexPoly(u.q, u.r);
        let key = (u.side==='blue'?'UK_':'GER_') + (u.unitType==='infantry'?'Inf':'Veh');
        overlayGroup.add(scene.add.image(p.x, p.y, key).setDisplaySize(HEX_RADIUS*1.4, HEX_RADIUS*1.4));
        
        // Arrow
        const arrow = scene.add.graphics();
        const a = Phaser.Math.DegToRad([-90,-30,30,90,150,-150][u.facing]);
        arrow.fillStyle(0xdd0000).fillTriangle(
            p.x+Math.cos(a)*30, p.y+Math.sin(a)*30,
            p.x+Math.cos(a+2.6)*10, p.y+Math.sin(a+2.6)*10,
            p.x+Math.cos(a-2.6)*10, p.y+Math.sin(a-2.6)*10
        );
        overlayGroup.add(arrow);
    });

    // 4. Victory Stars
    victoryLocations.forEach(vl => {
        const p = getHexPoly(vl.q, vl.r);
        overlayGroup.add(scene.add.star(p.x, p.y, 5, 8, 16, 0xffcc00).setStrokeStyle(2, 0x000000));
        overlayGroup.add(scene.add.text(p.x, p.y+10, vl.points, {fontSize:'10px', stroke:'#000', strokeThickness:3}).setOrigin(0.5));
    });
}

// --- DATA HELPERS & UI UPDATE ---

function addTrayUnit() {
    const side = document.getElementById('tray-side').value;
    const type = document.getElementById('tray-type').value;
    trayUnits.push({ id: idCounter++, side, type });
    updateLists();
}
function addReinf() {
    const side = document.getElementById('reinf-side').value;
    const type = document.getElementById('reinf-type').value;
    reinforcements.push({
        id: idCounter++, side, type,
        turn: document.getElementById('reinf-turn').value, chance: document.getElementById('reinf-chance').value,
        locType: document.getElementById('reinf-loc-type').value, locVal: document.getElementById('reinf-val').value
    });
    updateLists();
}
function addOffBoard() {
    offBoardAssets.push({
        id: idCounter++, type: document.getElementById('off-type').value, side: document.getElementById('off-side').value,
        turn: document.getElementById('off-turn').value, chance: document.getElementById('off-chance').value
    });
    updateLists();
}

function updateLists() {
    // Helper to generate Rich HTML for items
    const renderUnitItem = (u, extraText, deleteFn) => {
        let name = (u.side==='blue' ? 'UK ' : 'GER ') + u.type.charAt(0).toUpperCase() + u.type.slice(1);
        let imgKey = (u.side==='blue' ? 'UK_' : 'GER_') + (u.type==='infantry'?'Inf':'Veh');
        return `
        <div class="list-item">
            <div style="display:flex; align-items:center;">
                <img src="${ASSETS_URL}counters/${imgKey}.png" class="item-icon">
                <div class="item-info">
                    <div class="item-title">${name}</div>
                    <div class="item-meta">${extraText}</div>
                </div>
            </div>
            <span class="del-x" onclick="${deleteFn}(${u.id})">X</span>
        </div>`;
    };

    // Tray Lists
    document.getElementById('list-tray-blue').innerHTML = trayUnits.filter(u=>u.side==='blue').map(u => renderUnitItem(u, "Setup Tray", "remTray")).join('');
    document.getElementById('list-tray-red').innerHTML = trayUnits.filter(u=>u.side==='red').map(u => renderUnitItem(u, "Setup Tray", "remTray")).join('');
    
    // Reinforcements
    document.getElementById('list-reinf').innerHTML = reinforcements.map(r => {
        let loc = r.locType==='setup' ? "SETUP ZONE" : r.locVal;
        return renderUnitItem(r, `Turn ${r.turn} (${r.chance}%) @ ${loc}`, "remReinf");
    }).join('');

    // Offboard
    document.getElementById('list-offboard').innerHTML = offBoardAssets.map(o => {
        let name = (o.side==='blue'?'UK ':'GER ') + (o.type==='artillery'?'Artillery':'Air Strike');
        return `<div class="list-item">
            <div class="item-info"><div class="item-title">${name}</div><div class="item-meta">Turn ${o.turn} (${o.chance}%)</div></div>
            <span class="del-x" onclick="remOff(${o.id})">X</span>
        </div>`;
    }).join('');

    // Victory
    document.getElementById('list-vl').innerHTML = victoryLocations.map(v => 
        `<div class="list-item"><div class="item-info"><div class="item-title">Hex [${v.q},${v.r}]</div><div class="item-meta">${v.points} Points</div></div></div>`
    ).join('');
}

window.remTray = (id) => { trayUnits = trayUnits.filter(u=>u.id!==id); updateLists(); };
window.remReinf = (id) => { reinforcements = reinforcements.filter(u=>u.id!==id); updateLists(); };
window.remOff = (id) => { offBoardAssets = offBoardAssets.filter(u=>u.id!==id); updateLists(); };

function regenerateMap() {
    mapData.cols = parseInt(document.getElementById('cols').value);
    mapData.rows = parseInt(document.getElementById('rows').value);
    hexMap = {};
    for (let q = 0; q < mapData.cols; q++) {
        hexMap[q] = {};
        for (let r = 0; r < mapData.rows; r++) hexMap[q][r] = { q, r, terrain: 'clear', variant: 1, setupZone: null };
    }
    units = units.filter(u => u.q < mapData.cols && u.r < mapData.rows);
    drawMap();
}

function exportScenario() {
    const terrainExp = [];
    const zonesExp = [];
    for(let q in hexMap) {
        for(let r in hexMap[q]) {
            if(hexMap[q][r].terrain !== 'clear') terrainExp.push({q:parseInt(q), r:parseInt(r), type:hexMap[q][r].terrain});
            if(hexMap[q][r].setupZone) zonesExp.push({q:parseInt(q), r:parseInt(r), side:hexMap[q][r].setupZone});
        }
    }
    const scenario = {
        info: {
            title: document.getElementById('scen-title').value,
            author: document.getElementById('scen-author').value,
            description: document.getElementById('scen-desc').value,
            maxTurns: parseInt(document.getElementById('scen-turns').value),
            environment: { visibility: document.getElementById('env-vis').value, time: document.getElementById('env-time').value },
            cp: { blue: document.getElementById('cp-blue').value, red: document.getElementById('cp-red').value }
        },
        map: { cols: mapData.cols, rows: mapData.rows, terrain: terrainExp, roads: roadSegments, zones: zonesExp },
        units: { locked: units, tray: trayUnits, reinforcements: reinforcements },
        support: offBoardAssets,
        victory: { locations: victoryLocations, thresholds: { blue: document.getElementById('thresh-blue').value, red: document.getElementById('thresh-red').value } }
    };
    document.getElementById('json-input').value = JSON.stringify(scenario, null, 2);
    toggleModal();
}

// --- UTILS ---
function initUI() {
    const pal = document.getElementById('terrain-palette');
    for(const k in TERRAIN_TYPES) {
        const div = document.createElement('div'); div.className = 'terrain-item';
        div.innerHTML = `<img src="${ASSETS_URL}map/${k}1.png">`;
        div.onclick = () => { activeTerrain=k; setMode('paint'); document.querySelectorAll('.terrain-item').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); };
        pal.appendChild(div);
    }
}
window.setMode = (m) => {
    currentMode = m;
    document.getElementById('status-bar').style.display='block'; document.getElementById('status-bar').innerText = "MODE: "+m.toUpperCase();
    document.getElementById('btn-road').classList.toggle('btn-active', m==='road');
    document.getElementById('btn-vl').classList.toggle('btn-active', m==='vl');
    document.getElementById('btn-zone-uk').classList.toggle('btn-active', m==='zone-uk');
    document.getElementById('btn-zone-ger').classList.toggle('btn-active', m==='zone-ger');
}
window.toggleModal = () => document.getElementById('json-modal').style.display = document.getElementById('json-modal').style.display==='block' ? 'none':'block';

window.loadJSON = () => {
    try {
        const data = JSON.parse(document.getElementById('json-input').value);
        document.getElementById('cols').value = data.map.cols; document.getElementById('rows').value = data.map.rows;
        regenerateMap();
        data.map.terrain.forEach(t => { if(hexMap[t.q]) hexMap[t.q][t.r].terrain = t.type; });
        if(data.map.zones) data.map.zones.forEach(z => { if(hexMap[z.q]) hexMap[z.q][z.r].setupZone = z.side; });
        roadSegments = data.map.roads || [];
        units = data.units.locked || []; trayUnits = data.units.tray || []; reinforcements = data.units.reinforcements || [];
        if(data.victory) victoryLocations = data.victory.locations || [];
        updateLists(); drawMap(); toggleModal();
    } catch(e) { alert("Invalid JSON"); }
}

function getHexAtPoint(wx, wy) {
    let closest = null, minDist = Infinity;
    for(let q=0; q<mapData.cols; q++) for(let r=0; r<mapData.rows; r++) {
        const p = getHexPoly(q,r); const d = Phaser.Math.Distance.Between(wx, wy, p.x, p.y);
        if(d < HEX_RADIUS && d < minDist) { minDist = d; closest = hexMap[q][r]; }
    }
    return closest;
}
</script>
</body>
</html>
