<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wargame Engine v0.8.1 - Stable Loading</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        :root { --bg-dark: #1e1e1e; --bg-panel: #2a2a2a; --accent: #d4a017; --text-main: #e0e0e0; --text-dim: #a0a0a0; --border: #444; }
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; display: grid; grid-template-columns: 260px 1fr 320px; overflow: hidden; }
        
        /* LAYOUT */
        #left-panel, #right-panel { background: var(--bg-panel); padding: 15px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; z-index: 10; }
        #left-panel { border-right: 1px solid var(--border); }
        #right-panel { border-left: 1px solid var(--border); display: grid; grid-template-rows: auto 1fr 200px; }
        #game-container { position: relative; overflow: hidden; background: #111; }

        /* UI ELEMENTS */
        .panel-header { color: var(--accent); font-size: 18px; font-weight: bold; margin-bottom: 5px; border-bottom: 2px solid var(--accent); padding-bottom: 5px; }
        .scenario-box { background: #333; border: 1px solid var(--border); padding: 10px; border-radius: 4px; font-size: 13px; min-height: 80px; }
        .turn-display { text-align: center; font-size: 14px; font-weight: bold; background: #222; padding: 10px; border: 1px solid var(--border); border-radius: 4px; }
        .btn { background: #444; color: var(--text-main); border: 1px solid #555; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; transition: background 0.2s; text-align: center; }
        .btn:hover { background: #555; border-color: #777; }
        .btn-primary { background: #d4a017; color: #111; border: none; }
        .btn-primary:hover { background: #b88a10; }
        .btn.active { background: var(--accent); color: #000; border-color: var(--accent); }

        /* TRAY & LISTS */
        .tray-item { display: flex; align-items: center; gap: 10px; background: #222; border: 1px solid #444; padding: 5px; margin-bottom: 5px; cursor: pointer; }
        .tray-item:hover { background: #333; border-color: #666; }
        .tray-item.selected { border-color: var(--accent); background: #332200; }
        .tray-icon { width: 32px; height: 32px; object-fit: contain; }
        
        .tool-sub-options { display: flex; gap: 5px; margin-top: 5px; }
        .btn-small { padding: 5px; font-size: 11px; flex: 1; }

        /* CONTEXT PANEL */
        #context-card { padding: 15px; background: #333; border-bottom: 1px solid var(--border); text-align: center; min-height: 140px; }
        .ctx-portrait { width: 80px; height: 80px; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; }
        .ctx-portrait img { width: 100%; height: 100%; object-fit: contain; }
        .ctx-title { font-size: 16px; font-weight: bold; color: white; }
        .ctx-subtitle { font-size: 12px; color: var(--accent); margin-bottom: 5px; }
        
        .status-badges { display: flex; gap: 5px; justify-content: center; margin-top: 5px; flex-wrap: wrap; }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 3px; font-weight: bold; cursor: default; }
        .badge-terrain { cursor: pointer; border: 1px solid rgba(255,255,255,0.2); }
        .badge-shaken { background: #c62828; color: white; }
        .badge-damage { background: #333; border: 1px solid #c62828; color: #ff8888; }

        #context-stats { padding: 15px; overflow-y: auto; }
        .stat-row { display: flex; justify-content: space-between; border-bottom: 1px solid #3a3a3a; padding: 4px 0; font-size: 13px; }
        .stat-label { color: var(--text-dim); }
        .stat-value { font-weight: bold; color: white; }

        #stack-list { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .stack-item { cursor: pointer; border: 1px solid #444; border-radius: 4px; background: #222; padding: 5px; display: flex; align-items: center; gap: 10px; }
        .stack-item:hover { border-color: var(--accent); background: #333; }
        .stack-img { width: 40px; height: 40px; object-fit: contain; }
        .stack-info { flex-grow: 1; font-size: 11px; text-align: left; }

        #log-container { background: #111; border-top: 1px solid var(--accent); padding: 10px; font-family: 'Consolas', monospace; font-size: 11px; overflow-y: auto; color: #ccc; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .log-turn { color: var(--accent); font-weight: bold; margin-top: 8px; }
        .log-combat { color: #ff5555; }
        .log-info { color: #88ccff; }

        #json-modal { position: absolute; top: 50px; left: 50px; width: 300px; background: #222; border: 2px solid var(--accent); padding: 15px; z-index: 2000; display: none; }
    </style>
</head>
<body>

<div id="left-panel">
    <div class="panel-header">SCENARIO</div>
    <div class="scenario-box" id="scenario-info-box">
        <strong style="color:white">Wargame Engine</strong><br>
        <span style="color:#aaa">Ready</span><br>
        <p style="margin:5px 0 0 0; color:#888; font-style:italic">Load map to initialize...</p>
    </div>

    <div class="turn-display">
        TURN: <span id="turn-counter">1</span> / <span id="max-turns">-</span><br>
        <span style="color: var(--accent); font-size:12px;" id="phase-display">WAITING</span>
    </div>

    <button class="btn btn-primary" id="btn-phase" onclick="nextPhase()">Start Game</button>
    
    <div id="left-content-area" style="flex-grow:1; overflow-y:auto; margin-top:10px;"></div>
    
    <div class="panel-header" style="margin-top:10px">TOOLS</div>
    <div>
        <button class="btn" id="btn-los" style="width:100%" onclick="toggleLOSTool()">Line of Sight Tool</button>
        <div id="los-options" class="tool-sub-options" style="display:none;">
            <button id="los-inf" class="btn btn-small active" onclick="setLOSType('infantry')">Infantry</button>
            <button id="los-veh" class="btn btn-small" onclick="setLOSType('vehicle')">Vehicle</button>
        </div>
    </div>
    <button class="btn" onclick="toggleMapLoader()">Load Scenario JSON</button>
</div>

<div id="game-container">
    <div id="json-modal">
        <textarea id="json-input" rows="6" style="width:100%; background:#111; color:#fff; border:1px solid #444;" placeholder="Paste Scenario JSON..."></textarea>
        <button class="btn btn-primary" style="width:100%; margin-top:5px;" onclick="loadScenario()">Load</button>
        <button class="btn" style="width:100%; margin-top:5px;" onclick="toggleMapLoader()">Close</button>
    </div>
</div>

<div id="right-panel">
    <div id="context-card">
        <div class="ctx-portrait" id="ctx-img"></div>
        <div class="ctx-title" id="ctx-title">No Selection</div>
        <div class="ctx-subtitle" id="ctx-subtitle">-</div>
        <div class="status-badges" id="ctx-badges"></div>
        <div id="unit-actions" style="margin-top:10px; display:none; gap:5px; grid-template-columns: 1fr 1fr;">
            <button class="btn btn-game" style="padding:5px" onclick="selectAction('TACTICAL')">Tactical</button>
            <button class="btn btn-game" style="padding:5px" onclick="selectAction('FAST')">Fast</button>
            <button class="btn btn-game" style="padding:5px" onclick="selectAction('FACING')">Face</button>
            <button class="btn btn-game" style="padding:5px; border-color:#ff5555; color:#ff5555" onclick="selectAction('FIRE')">FIRE</button>
            <button class="btn btn-setup" style="padding:5px; display:none" onclick="selectAction('FACING')">Rotate</button>
            <button class="btn btn-setup" style="padding:5px; border-color:#ffaa00; color:#ffaa00; display:none" onclick="redeployUnit()">Redeploy</button>
        </div>
    </div>
    <div id="context-stats">
        <div class="panel-header" style="font-size:14px; border-width:1px;" id="stats-header">STATISTICS</div>
        <div id="stats-content"></div>
        <div id="stack-container" style="display:none; margin-top:15px;">
            <div class="panel-header" style="font-size:14px; border-width:1px;">STACK (Top First)</div>
            <div id="stack-list"></div>
        </div>
    </div>
    <div id="log-container"><div class="log-entry">System initialized.</div></div>
</div>

<script>
// --- GLOBAL CONFIGURATION & STATE ---
const ASSETS_URL = 'https://raw.githubusercontent.com/trainJapan/HexWargame/main/artwork/';
const TERRAIN_TYPES = {
    'clear':      { color: 0x98FB98, los: 'clear',     cost: 1,   terrainHeight: 0, infantryUsable: 0, vehicleUsable: 0 },
    'fields':     { color: 0xCCAA00, los: 'degrading', cost: 1,   terrainHeight: 1, infantryUsable: 0, vehicleUsable: 0 },
    'beach':      { color: 0xFFFF99, los: 'clear',     cost: 1,   terrainHeight: 0, infantryUsable: 0, vehicleUsable: 0 },
    'broken':     { color: 0x8B4513, los: 'degrading', cost: 2,   terrainHeight: 1, infantryUsable: 0, vehicleUsable: 0 },
    'orchard':    { color: 0x00FF00, los: 'degrading', cost: 2,   terrainHeight: 1, infantryUsable: 0, vehicleUsable: 0 },
    'rural':      { color: 0xFF9999, los: 'degrading', cost: 2,   terrainHeight: 1, infantryUsable: 0, vehicleUsable: 0 },
    'forest':     { color: 0x228B22, los: 'blocking',  cost: 3,   terrainHeight: 2, infantryUsable: 0, vehicleUsable: 0 },
    'urban':      { color: 0xCC0000, los: 'blocking',  cost: 3,   terrainHeight: 2, infantryUsable: 2, vehicleUsable: 0 },
    'industrial': { color: 0x808080, los: 'blocking',  cost: 3,   terrainHeight: 2, infantryUsable: 2, vehicleUsable: 0 },
    'water':      { color: 0x4169E1, los: 'clear',     cost: 999, terrainHeight: 0, infantryUsable: 0, vehicleUsable: 0 },
    'hill':       { color: 0x8B7355, los: 'degrading', cost: 2,   terrainHeight: 2, infantryUsable: 2, vehicleUsable: 2 }
};
const HEX_RADIUS = 40;

// Data Objects
let scenarioData = null; 
let mapData = null; 
let hexMap = {}; // Grid storage

// Gameplay State
let units = [];
let trayUnits = [];
let unitIdCounter = 3000;
let currentTurn = 1;
let currentPhase = 'SETUP'; 
let selectedUnit = null; 
let selectedHex = null; 
let selectedTrayUnit = null;
let currentAction = null; 
let losTool = false;
let losStartHex = null;
let losUnitType = 'infantry';

// Phaser Objects
let scene, hexGroup, zoneGraphics, roadGraphics, losGraphics, unitGraphics, selectionGraphics, badgeGraphics;
let unitSprites = {};

// --- CRITICAL FUNCTIONS: Defined first to avoid "not defined" errors ---

function loadScenario() {
    let raw = document.getElementById('json-input').value;
    // Clean invisible characters
    let clean = raw.replace(/\u00A0/g, ' ').replace(/[\n\r]+/g, ' ').trim();

    try {
        scenarioData = JSON.parse(clean);
        mapData = scenarioData.map; // GLOBAL ASSIGNMENT

        units = []; trayUnits = [];
        
        if (scenarioData.units.locked) {
            scenarioData.units.locked.forEach(u => { u.isFixed = true; units.push(u); });
        }
        if (scenarioData.units.tray) {
            trayUnits = [...scenarioData.units.tray];
        }
        
        document.getElementById('scenario-info-box').innerHTML = `
            <strong style="color:white">${scenarioData.info.title}</strong><br>
            <span style="color:#aaa">${scenarioData.info.author}</span><br>
            <div style="margin:5px 0 0 0; font-size:11px; color:#888; max-height:100px; overflow-y:auto">
                ${scenarioData.info.description}
            </div>
        `;
        document.getElementById('max-turns').innerText = scenarioData.info.maxTurns;

        currentPhase = 'SETUP';
        document.getElementById('phase-display').innerText = 'SETUP';
        document.getElementById('btn-phase').innerText = 'Finish Setup';
        document.getElementById('left-content-area').innerHTML = '';
        
        displayMap(); // DRAW
        renderTray();
        toggleMapLoader();
        addToLog("Scenario Loaded.");
        
    } catch (e) { 
        alert('Error: ' + e.message); console.error(e); 
    }
}

function displayMap() {
    if (!mapData || !scene) return;
    
    // Clear Groups
    hexGroup.clear(true, true); 
    roadGraphics.clear(); 
    if(zoneGraphics) zoneGraphics.clear(); else zoneGraphics = scene.add.graphics().setDepth(20);

    hexMap = {}; // Reset Grid
    
    // Initialize Hexes based on cols/rows
    for (let q = 0; q < mapData.cols; q++) {
        hexMap[q] = {};
        for (let r = 0; r < mapData.rows; r++) {
            const pos = getHexPosition(q, r);
            hexMap[q][r] = { terrain: 'clear', x: pos.x, y: pos.y, q: q, r: r, hasRoad: false, variant: null };
        }
    }
    
    // Terrain
    if (mapData.terrain) mapData.terrain.forEach(t => { 
        if (hexMap[t.q] && hexMap[t.q][t.r]) hexMap[t.q][t.r].terrain = t.type; 
    });
    
    // Roads
    if (mapData.roads) mapData.roads.forEach(road => {
        if (hexMap[road.from.q]) hexMap[road.from.q][road.from.r].hasRoad = true;
        if (hexMap[road.to.q]) hexMap[road.to.q][road.to.r].hasRoad = true;
    });

    // Setup Zones
    if (currentPhase === 'SETUP' && mapData.zones) {
        mapData.zones.forEach(z => {
            if (hexMap[z.q] && hexMap[z.q][z.r]) {
                hexMap[z.q][z.r].setupZone = z.side;
                const p = getHexPosition(z.q, z.r);
                const pts = []; 
                for(let i=0; i<6; i++) {
                    const a = Math.PI/3*i; 
                    pts.push({x: p.x+HEX_RADIUS*Math.cos(a), y: p.y+HEX_RADIUS*Math.sin(a)}); 
                }
                const color = z.side === 'blue' ? 0x4488ff : 0xff4444;
                zoneGraphics.fillStyle(color, 0.2).fillPoints(pts, true);
            }
        });
    }

    // Render Grid
    for (let q = 0; q < mapData.cols; q++) { 
        for (let r = 0; r < mapData.rows; r++) { 
            drawHex(hexMap[q][r]); 
        } 
    }
    drawRoads(); 
    redrawAllUnits();
}

// --- PHASER ENGINE SETUP ---
const config = {
    type: Phaser.AUTO, parent: 'game-container',
    width: window.innerWidth - 580, height: window.innerHeight,
    backgroundColor: '#1a1a1a',
    scene: { preload: preloadScene, create: createScene, update: updateScene }
};
const game = new Phaser.Game(config);

function preloadScene() {
    for (const k in TERRAIN_TYPES) for(let i=1; i<=3; i++) this.load.image(`${k}${i}`, `${ASSETS_URL}map/${k}${i}.png`);
    ['UK_Inf','UK_Veh','GER_Inf','GER_Veh'].forEach(k => this.load.image(k, `${ASSETS_URL}counters/${k}.png`));
}

function createScene() {
    scene = this;
    hexGroup = this.add.group(); 
    zoneGraphics = this.add.graphics().setDepth(20);
    roadGraphics = this.add.graphics().setDepth(100);
    selectionGraphics = this.add.graphics().setDepth(500); 
    losGraphics = this.add.graphics().setDepth(550);       
    unitGraphics = this.add.graphics().setDepth(700);      
    badgeGraphics = this.add.graphics().setDepth(800);     
    
    this.cameras.main.setBounds(-2000, -2000, 8000, 8000);
    this.input.mouse.disableContextMenu();
    this.input.on('wheel', (p, g, x, y) => scene.cameras.main.setZoom(Phaser.Math.Clamp(scene.cameras.main.zoom - y*0.001, 0.3, 2)));
    this.input.on('pointerdown', (pointer) => {
        if (pointer.leftButtonDown()) handleLeftClick(pointer);
        if (pointer.rightButtonDown()) handleRightClick();
    });
}

function updateScene() {
    if (this.input.activePointer.rightButtonDown()) {
        const p = this.input.activePointer;
        this.cameras.main.scrollX -= (p.x - p.prevPosition.x) / this.cameras.main.zoom;
        this.cameras.main.scrollY -= (p.y - p.prevPosition.y) / this.cameras.main.zoom;
    }
}

// --- GAME LOGIC ---

function handleLeftClick(pointer) {
    const hex = getHexAtPoint(pointer.worldX, pointer.worldY);
    if (!hex) { deselectAll(); return; }

    if (losTool) { handleLOSToolClick(hex); return; }

    if (currentPhase === 'SETUP' && selectedTrayUnit) {
        deployTrayUnit(selectedTrayUnit, hex);
        return;
    }

    const hexUnits = units.filter(u => u.q === hex.q && u.r === hex.r && u.hp > 0);
    if (currentAction && selectedUnit) {
        if (currentAction === 'FIRE') executeFire(selectedUnit, hexUnits.find(u => u.side !== selectedUnit.side));
        else if (currentAction === 'FACING') changeFacing(selectedUnit, hex);
        else executeMove(selectedUnit, hex);
        return;
    }

    if (hexUnits.length > 0) selectUnitInStack(hexUnits[hexUnits.length - 1]);
    else { selectedUnit = null; selectedHex = hex; uiUpdate(); }
}

function handleRightClick() {
    if (currentAction) { currentAction = null; uiUpdate(); addToLog("Cancelled."); }
    if (selectedTrayUnit) { selectedTrayUnit = null; renderTray(); }
}

function renderTray() {
    const c = document.getElementById('left-content-area');
    c.innerHTML = '<div class="panel-header" style="font-size:14px; border-width:1px;">SETUP TRAY</div>';
    if (trayUnits.length === 0) { c.innerHTML += '<div style="color:#666; font-style:italic; padding:10px;">Empty.</div>'; return; }
    trayUnits.forEach(u => {
        const item = document.createElement('div');
        item.className = `tray-item ${selectedTrayUnit === u ? 'selected' : ''}`;
        let k = (u.side==='blue'?'UK_':'GER_') + (u.type==='infantry'?'Inf':'Veh');
        item.innerHTML = `<img src="${ASSETS_URL}counters/${k}.png" class="tray-icon"><div><div style="font-weight:bold;font-size:12px;color:#fff">${u.type.toUpperCase()}</div></div>`;
        item.onclick = () => { selectedTrayUnit = (selectedTrayUnit === u) ? null : u; selectedUnit = null; renderTray(); };
        c.appendChild(item);
    });
}

function deployTrayUnit(uData, hex) {
    let valid = (uData.side === 'blue' && hex.setupZone === 'blue') || (uData.side === 'red' && hex.setupZone === 'red');
    if (!valid) { addToLog("Invalid Zone!", "log-combat"); return; }
    const newUnit = { id: unitIdCounter++, side: uData.side, unitType: uData.type, q: hex.q, r: hex.r, facing: 0, status: 'clear', mp: 6, maxMp: 6, hp: 5, fp: 3, range: 6, isFixed: false };
    units.push(newUnit);
    trayUnits = trayUnits.filter(t => t !== uData);
    selectedTrayUnit = null;
    selectUnitInStack(newUnit);
    displayMap(); renderTray(); uiUpdate();
}

function redeployUnit() {
    if (!selectedUnit || currentPhase !== 'SETUP' || selectedUnit.isFixed) return;
    trayUnits.push({ id: selectedUnit.id, side: selectedUnit.side, type: selectedUnit.unitType });
    units = units.filter(u => u !== selectedUnit);
    selectedUnit = null;
    displayMap(); renderTray(); uiUpdate();
}

function nextPhase() {
    if (currentPhase === 'SETUP') {
        if (trayUnits.length > 0 && !confirm("Units remain in Tray. Start?")) return;
        currentPhase = 'Action Phase';
        document.getElementById('btn-phase').innerText = "Next Phase >>";
        document.getElementById('left-content-area').innerHTML = ''; // Clear Tray
        displayMap(); // Remove Zones
        addToLog("=== START GAME ===", "log-turn");
    } else {
        addToLog(`Ending ${currentPhase}...`, "log-turn");
        currentPhase = (currentPhase === 'Action Phase') ? 'Fire Phase' : 'Action Phase';
        if(currentPhase === 'Action Phase') { currentTurn++; document.getElementById('turn-counter').innerText = currentTurn; addToLog(`Turn ${currentTurn}`, "log-turn"); }
    }
    document.getElementById('phase-display').innerText = currentPhase;
    uiUpdate();
}

// --- UTILS & DRAWING ---
function drawHex(hex) {
    const x = hex.x; const y = hex.y; const k = `${hex.terrain}${hex.variant || Phaser.Math.Between(1,3)}`;
    if (scene.textures.exists(k)) {
        const img = scene.add.image(x, y, k).setDisplaySize(HEX_RADIUS*2, HEX_RADIUS*2);
        const m = scene.make.graphics().beginPath().fillStyle(0xffffff);
        for(let i=0;i<6;i++) { const a=Math.PI/3*i; const px=x+HEX_RADIUS*Math.cos(a); const py=y+HEX_RADIUS*Math.sin(a); i===0?m.moveTo(px,py):m.lineTo(px,py); }
        m.closePath().fillPath(); img.setMask(m.createGeometryMask()); hexGroup.add(img);
        const l = scene.add.graphics().lineStyle(2,0x333333).beginPath();
        for(let i=0;i<6;i++) { const a=Math.PI/3*i; const px=x+HEX_RADIUS*Math.cos(a); const py=y+HEX_RADIUS*Math.sin(a); i===0?l.moveTo(px,py):l.lineTo(px,py); }
        l.closePath().strokePath(); hexGroup.add(l);
    }
}
function drawRoads() {
    if (!mapData || !mapData.roads) return;
    roadGraphics.lineStyle(6, 0x555555, 0.8);
    mapData.roads.forEach(s => { 
        const h1 = hexMap[s.from.q][s.from.r]; const h2 = hexMap[s.to.q][s.to.r];
        if(h1&&h2) roadGraphics.beginPath().moveTo(h1.x, h1.y).lineTo(h2.x, h2.y).strokePath();
    });
}
function redrawAllUnits() {
    Object.values(unitSprites).forEach(s => s.destroy()); unitSprites = {};
    const stacks = {}; units.forEach(u => { if(u.hp>0) stacks[`${u.q},${u.r}`] = (stacks[`${u.q},${u.r}`]||0)+1; });
    units.forEach(u => {
        if(u.hp<=0) return;
        const pos = getHexPosition(u.q, u.r);
        const k = (u.side==='blue'?'UK_':'GER_') + (u.unitType==='infantry'?'Inf':'Veh');
        if(scene.textures.exists(k)) {
            const s = scene.add.image(pos.x, pos.y, k).setDisplaySize(HEX_RADIUS*1.25, HEX_RADIUS*1.25).setDepth(600);
            unitSprites[u.id] = s;
        }
        if(selectedUnit===u) selectionGraphics.lineStyle(3,0xffcc00).strokeCircle(pos.x,pos.y,HEX_RADIUS*0.7);
        // Facing
        const a = Phaser.Math.DegToRad([-90,-30,30,90,150,-150][u.facing]);
        unitGraphics.fillStyle(0x8B0000).fillTriangle(pos.x+Math.cos(a)*30, pos.y+Math.sin(a)*30, pos.x+Math.cos(a)*30+Math.cos(a+2.5)*8, pos.y+Math.sin(a)*30+Math.sin(a+2.5)*8, pos.x+Math.cos(a)*30+Math.cos(a-2.5)*8, pos.y+Math.sin(a)*30+Math.sin(a-2.5)*8);
        // Stack Badge
        const isTop = (units.filter(x=>x.q===u.q && x.r===u.r).pop() === u);
        if(stacks[`${u.q},${u.r}`]>1 && isTop) {
            badgeGraphics.fillStyle(0xffffff).fillRect(pos.x+10, pos.y-18, 16, 14).lineStyle(1,0x000000).strokeRect(pos.x+10, pos.y-18, 16, 14);
            scene.add.text(pos.x+18, pos.y-11, `+${stacks[`${u.q},${u.r}`]-1}`, {font:'11px Arial',fill:'#000',fontStyle:'bold'}).setOrigin(0.5).setDepth(810).setName('badgeText');
        }
        if(isTop && u.isFixed && currentPhase === 'SETUP') {
             // Fixed Marker handled in UI panel, but we could add visual here if needed
        }
    });
}

function uiUpdate() {
    selectionGraphics.clear(); unitGraphics.clear(); badgeGraphics.clear();
    scene.children.list.filter(c => c.name === 'badgeText').forEach(c => c.destroy());
    redrawAllUnits();
    if (!selectedUnit && selectedHex) selectionGraphics.lineStyle(3, 0xffffff).strokeCircle(selectedHex.x, selectedHex.y, HEX_RADIUS - 5);
    
    // Panel Logic
    if (selectedUnit) {
        let k = (selectedUnit.side==='blue'?'UK_':'GER_') + (selectedUnit.unitType==='infantry'?'Inf':'Veh');
        document.getElementById('ctx-img').innerHTML = `<img src="${ASSETS_URL}counters/${k}.png">`;
        document.getElementById('ctx-title').innerText = selectedUnit.unitType.toUpperCase();
        document.getElementById('unit-actions').style.display = 'grid';
        document.querySelectorAll('.btn-game').forEach(b => b.style.display = currentPhase==='SETUP'?'none':'block');
        document.querySelectorAll('.btn-setup').forEach(b => b.style.display = (currentPhase==='SETUP' && !selectedUnit.isFixed)?'block':'none');
        
        const bC = document.getElementById('ctx-badges'); bC.innerHTML = '';
        if(selectedUnit.isFixed && currentPhase === 'SETUP') bC.innerHTML += '<span class="badge" style="background:#555">FIXED</span>';
        bC.innerHTML += `<span class="badge badge-terrain" style="background:#444">${hexMap[selectedUnit.q][selectedUnit.r].terrain.toUpperCase()}</span>`;
        
        document.getElementById('stats-content').innerHTML = `<div>MP: ${selectedUnit.mp}/${selectedUnit.maxMp}</div><div>HP: ${selectedUnit.hp}/5</div>`;
    } else {
        document.getElementById('ctx-img').innerHTML = ''; document.getElementById('ctx-title').innerText = "No Selection";
        document.getElementById('unit-actions').style.display = 'none'; document.getElementById('ctx-badges').innerHTML = '';
        document.getElementById('stats-content').innerHTML = '';
    }
}
function deselectAll() { selectedUnit = null; selectedHex = null; uiUpdate(); }
function selectUnitInStack(u) { selectedUnit = u; selectedHex = null; units = units.filter(x=>x!==u); units.push(u); uiUpdate(); }
function addToLog(m) { const d=document.getElementById('log-container'); d.innerHTML+=`<div class="log-entry">${m}</div>`; d.scrollTop=d.scrollHeight; }
function toggleMapLoader() { const d=document.getElementById('json-modal'); d.style.display=d.style.display==='block'?'none':'block'; }

// --- GEOMETRY & LOS ---
function getHexPosition(q, r) { const x = q*HEX_RADIUS*1.5; const y = r*HEX_RADIUS*Math.sqrt(3) + (q%2?HEX_RADIUS*Math.sqrt(3)/2:0); return { x, y }; }
function getHexAtPoint(wx, wy) {
    if (!mapData) return null;
    let c = null, md = Infinity;
    // Optimization: Check only nearby cols/rows if map is huge
    // But for 50x50, iteration is fast enough.
    for (let q=0; q<mapData.cols; q++) for (let r=0; r<mapData.rows; r++) {
        const h = hexMap[q][r]; const d = Math.sqrt((h.x-wx)**2 + (h.y-wy)**2);
        if(d < HEX_RADIUS && d < md) { md = d; c = h; }
    }
    return c;
}
// Placeholder LOS (Full function omitted for brevity, logic same as previous)
function calculateLOS(start, end, type) { return { status: 'clear', isRoad: false }; }
function executeMove(u, h) { u.q=h.q; u.r=h.r; uiUpdate(); currentAction=null; }
function executeFire(a, t) { if(t) { t.hp--; if(t.hp<=0) units=units.filter(x=>x!==t); } uiUpdate(); currentAction=null; }
function changeFacing(u, h) { u.facing = (u.facing+1)%6; uiUpdate(); currentAction=null; if(currentPhase==='SETUP') redrawAllUnits(); }
</script>
</body>
</html>
